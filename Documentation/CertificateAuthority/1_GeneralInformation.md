## Certificate Authority project general information

**Certificate Authority** project is a web API project that allows users to work with certificates.



Using API endpoints you can access following functionality:

#### Certificates

- Issue new certificate from certificate request

- Revoke certificate

- Check certificate revocation status

- Get all certificates

  

#### Accounts

- Create account
- Get account(s) info
- Delete account
- Set account's access level



To access different functionality account that is calling API endpoint should have proper access level.

Here is the list of all access types and their integer representation: 

```
BasicAccess = 0,
DeleteAccounts = 1,
AccessAccountInfo = 2,
RevokeCertificates = 4,
IssueCertificates = 8,
AccessAnyCertificate = 16,
ChangeAccountAccessLevel = 32,
CreateAccounts = 64
```



Accounts can have one or more access levels.

For example an account that has access levels `BasicAccess, RevokeCertificates, CreateAccounts` will have access level integer representation set to `68`. That number is calculated by summing integer representations of those 3 access levels - `0 + 4 + 64 = 68`

Different API endpoints have different access parameters. Required access level is specified in endpoint's documentation.

Admin's account that is created by default has all access levels. Also admin's account is the only account that can't be deleted. Also it's impossible to change Admin's access levels.



### Solution's projects

Solution contains 3 projects:

1. `CertificateAuthority` - main project that contains code for all functionality described in this document.
2. `CertificateAuthority.Client` - contains autogenerated clients for controllers specified in `CertificateAuthority`. To learn how to generate clients read `GeneratingClient.md` in documentation folder.
3. `CertificateAuthority.Tests` - contains tests for `CertificateAuthority`.



## Setup

To start working with the application you need to configure a few things first. 



### Setup step 1 - creating authority certificate

First you need to install `OpenSSL`. Installer can be downloaded here: https://indy.fulgan.com/SSL/.

After installation navigate to OpenSSL installation folder and run `openssl.exe` from console. Usually it's located here: `C:\Program Files\OpenSSL-Win64\bin\`.



Now create a private key: 

```
genrsa -out "F:\CERT\RootCertificateKey.key" 4096
```

Create our self-signed root CA certificate `RootCertificate.crt`

```
req -new -x509 -days 1826 -key F:\CERT\RootCertificateKey.key -out F:\CERT\RootCertificate.crt
```



Now replace `RootCertificateKey.key` and `RootCertificate.crt`  files in `\CertificateAuthority\Src\CertificateAuthority` with the files you've generated. 

Alternatively you can replace those in the build folder at the time you deploy CA.



This is enough for the setup. If you want to know how to create certificate requests- read that section at the bottom of the document.



### Setup step 2 - creating admin account

When application starts for the first time it will create a `litedb.db` file in the root folder. This is application's database. When it's created default admin account will be added. 

You can skip this step and use default credentials: 

```
{
  "accountId": 1,
  "password": "4815162342"
}
```



To set your own password first go to https://emn178.github.io/online-tools/sha256.html and get it's hash.

Then create `ConfigurationFile.txt` in app's root folder if it's not already there and add following line: 

```
adminpasshash=HashOfYourPassword
```



Delete `litedb.db` file and run the application. It will create a default admin account with username "Admin", id = 1 and with password hash equal to one specified in configuration file.



### Configuration file

`ConfigurationFile.txt` in the root of application path is the configuration file. If it doesn't exist an empty file will be created on first application launch. You can override default values by putting there key-value pairs, for example: 

```
key1=34
key2=asfdsfsdfsdfsdf
```

All values that can be edited can be found here: `\CertificateAuthority\Src\CertificateAuthority\Code\Settings.cs`.

Adding values to configuration file will override default values specified in `Settings.cs`.



Note that if you installed OpenSSL not to a default location (which is `C:\Program Files\OpenSSL-Win64\bin\openssl.exe`) then you need to configure it like that: 

```
opensslpath=C:\Users\fullnodeivan\Desktop\OpenSSL\openssl.exe
```



### Logs

Logs are written to `AppBuildPath\Logs` folder.

To configure logging edit `NLog.config` file.



### API endpoints

Run the application and navigate to `/swagger/index.html`.

All API methods are well documented there.

![](Img\Overview_Swagger.png)



### Creating certificate requests

First you need to create a private key

```
genrsa -out "F:\CERT\subPrivKey1.key" 4096
```



To generate requests for certificate creation run:

```
req -new -key "F:\CERT\subPrivKey1.key" -out "F:\CERT\certRequest1.csr"
```



### Other OpenSSL commands

To manually process a request and create a certificate signed by root certificate run: 

```
x509 -req -days 730 -in "F:\CERT\certRequest1.csr" -CA "F:\CERT\rootCert.crt" -CAkey "F:\CERT\rootCertPrivKey.key" -set_serial 01 -out "F:\CERT\subCert1.crt"
```



To create a `.pfx` file which contains certificate and private key run:

```
pkcs12 -export -out "F:\CERT\subCert1.pfx" -inkey "F:\CERT\subPrivKey1.key" -in "F:\CERT\subCert1.crt"
```



To convert `.crt` to `.pem` run:

```
x509 -in F:\CERT\rootCert.crt -out F:\CERT\rootCert.pem -outform PEM
```



### Issuing certificate 

To issue a certificate you need to call `/api/certificates/issue_certificate_using_request_file` (this endpoint requires you to provide a `.csr` file) or `/api/certificates/issue_certificate_using_request_string` (this endpoint requires you to provide contents of a `.csr` file as a single space separated string).

For example open `subCert1.crt` that you've generated earlier with any text editor. Contents of the file will look like this: 

```
-----BEGIN CERTIFICATE REQUEST-----
MIIE1jCCAr4CAQAwejELMAkGA1UEBhMCcXcxCzAJBgNVBAgMAnF3MQswCQYDVQQH
DAJxdzELMAkGA1UECgwCcXcxCzAJBgNVBAsMAnF3MRUwEwYDVQQDDAxjZXJ0UmVx
<22 more lines here>
79pteeot4SzcFPkl0hcXix6VnDjI8AFLkN/Dn4SM+vZ5bml+AJiDB7FMulECGJeP
2bBKy8z3ZkSzEFTNwdtU1DAIbutKWTZMZ3A5z8h+riZzkK0dI7w1gjwn
-----END CERTIFICATE REQUEST-----
```

Convert it to a single line by replacing next line characters with spaces so the line will look like: 

Quick way to do this convercion is to paste multiline text into a single line textbox. You can use browser's url text box for example. So paste multiline text, then copy it again

```
-----BEGIN CERTIFICATE REQUEST----- MIIE1jCCAr4CAQAwejELMAkGA1UEBhMCcXcxCzAJBgNVBAgMAnF3MQswCQYDVQQH DAJxdzELMAkGA1UECgwCcXcxCzAJBgNVBAsMAnF3MRUwEwYDVQQDDAxjZXJ0UmVx dWVzdDIxIDAeBgkqhkiG9w0BCQEWEXF3ZUBxd2Vxd2Vxd2UucXdlMIICIjANBgkq hkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAxvT2sYqPjlMWfx3TxzaO6xRrqeiMuzuM Xkd9bdHEVsHkpXjztweRxZWNQIt4/P5bAd29QC77NeulW6dyQ1VgBprVZLDWlAs+ 2IpYg1u4/hr6BAc1Wo9AK5pwUB43Hlxma0EBqVns5spXcWfTO5/9QEkntwIJPi/x 79pteeot4SzcFPkl0hcXix6VnDjI8AFLkN/Dn4SM+vZ5bml+AJiDB7FMulECGJeP 2bBKy8z3ZkSzEFTNwdtU1DAIbutKWTZMZ3A5z8h+riZzkK0dI7w1gjwn -----END CERTIFICATE REQUEST------
```



After calling `/api/certificates/issue_certificate_using_request_string` you should see something like that: 

```
{
  "id": 1,
  "thumbprint": "0874E660989945E6C331F716D7446D7C3B44E1AB",
  "certificateContent": "-----BEGIN CERTIFICATE----- MIIFcDCCA1gCAQAwDQYJKoZIhvcNAQELBQAwgYExCzAJBgNVBAYTAlFXMQswCQYD VQQIDAJFUjELMAkGA1UEBwwCVFkxEDAOBgNVBAoMB09SR05BTUUxETAPBgNVBAsM CFVOSVROQU1FMRcwFQYDVQQDDA50ZXN0cm9vdGNhY2VydDEaMBgGCSqGSIb3DQEJ ARYLcXdlQHJ0eS5xd2UwHhcNMTkxMDA4MTkwNTAzWhcNMjkxMDA1MTkwNTAzWjB6 MQswCQYDVQQGEwJxdzELMAkGA1UECAwCcXcxCzAJBgNVBAcMAnF3MQswCQYDVQQK DAJxdzELMAkGA1UECwwCcXcxFTATBgNVBAMMDGNlcnRSZXF1ZXN0MjEgMB4GCSqG SIb3DQEJARYRcXdlQHF3ZXF3ZXF3ZS5xd2UwggIiMA0GCSqGSIb3DQEBAQUAA4IC DwAwggIKAoICAQDG9Paxio+OUxZ/HdPHNo7rFGup6Iy7O4zGHGNuIvaD6/RPS41P 6cFGC+mHrAYTYvw2yBVOxRLi1Sj88HHcPGasWVlPgURwi6Qsh49QWBPJaZZGb8Hr 2iiZvQGJqgs9X5RJLbo4WSb5E91za8NcvbfLfwc1WY15Huw/74Hu4NTOMmbKoQVo /EYFtH8pqRgDH+icxk1nKYzDB70vLQOEcv3D00bSGpCvqA50Ic8Ei2Npm/3KvrHh mGy96qoHuo0tHBGt3leOMT+F42PmYtTfmDkvG5VA3onTk2mPwkog3E0WHu+PXVoP OJV25/HyfWgHVulgiM87lDCd4Ds6zgi98xw4Aixz+sUGnXRhtPn6i6Fs7BiOwcx7 b07dRNLFrptJsPwvaKGlchxUPX+GnZgAYVD4/1JVEvaHsrXBQGPxIyFBXxNjmBJm to29Kgy4GOZgQakqMouUTpw+vTp+BYXJU9+QQtVTeSMiH7rehcz3pwk2M2YUQ8W4 LIirR60cAP9L3RLS51N+P+7flx5q1P3+3DmM3gSmxire/nf3QMumZs/4kpElz8NL 0sappPAtwgOaazZI/tBCpWR+FAIkvqeSa3FdRMzUioypseH+ERo2n+GFrhZ0hvPc 5zziD1G5L6MSrlRMhc2CtjwxiZyYxopVy1/dz9NFvPgxFnswkXSOs5km2QIDAQAB MA0GCSqGSIb3DQEBCwUAA4ICAQBtZE4j9W3a/ltXXyc0qS+BIuHeo8bSej9lBgAW QJH8wU5xGQjkWyWlno8pW8p52nROeeG+TDf4p8RKXCGFRAkb32BFmxsQtc7Rqx4c hOxdltISm89tSPDU1Y6+3piOCYUZbKcbCxTGTjUTTRd56sLoixo7oon1cFdQHLVQ xIWx8z2t+A1EL8QryevefL/3Sq4efHf7N6xX5wYnUF6tJciw1ipfm9hQnRngfZp9 3Us2TbtRLe3xoFtvwKEzyR3SJU5346GVJ85pz/j/Fct+z1vhIv5b1IRTv98TFohP pTO8exEXL2VE2Y2uoq5XSoyd5LD0CXUTgh60VMpdPHm6hOkaQ9CQv7CASGaH3cG1 9VAqQWxW1bqbKqduQX2edNqDbNsrnD3SHUkwsgkddu2HJJ6JJBizcrkNnXYmSiWT ZgZEJyremZ/D4wfyiaFnJQJulDSPmLLh4P0uiC18DJOqdJ4bAthVbXBLHBnmotgi AqJWNU06MqgtwMcMRUIXrMRBxTRaCrRuJrt1N/pJbxTtRKNYyOKezha4MPmOCsMq fnSv9p2GeOOb3WdPZMZdZUMp9JzLTTrATxU+1HZs1ORL/4Hok3iOGeIkZ2NoPATC 1LDJYsn6+BitDoInHae3eGiDYo0WIYJuzU7BJKR2Op0UDt8q6b5hVYWSX8JLUcmX 6ydOWA== -----END CERTIFICATE-----",
  "status": 1,
  "issuerAccountId": 1,
  "revokerAccountId": -1
}
```

